services:
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil", "--host", "0.0.0.0", "--chain-id", "8453", "--block-time", "1"]
    ports:
      - "8545:8545"
    volumes:
      - contracts-data:/data
    networks:
      - clawsino

  init:
    image: ghcr.io/foundry-rs/foundry:latest
    user: root
    volumes:
      - ./contracts:/contracts
      - ./scripts:/scripts
      - contracts-data:/data
    environment:
      - RPC_URL=http://anvil:8545
      - CONTRACTS_FILE=/data/contracts.json
    depends_on:
      - anvil
    networks:
      - clawsino
    entrypoint: ["/bin/sh", "/scripts/init.sh"]

  game-api:
    build:
      context: .
      dockerfile: server/Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - contracts-data:/data
    environment:
      - RPC_URL=http://anvil:8545
      - PORT=3000
      - X402_MODE=onchain
      - GAME_SERVER_PRIVATE_KEY=0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d
      - DASHBOARD_PATH=/dashboard
      - CONTRACTS_FILE=/data/contracts.json
    depends_on:
      init:
        condition: service_completed_successfully
    networks:
      - clawsino

networks:
  clawsino:
    driver: bridge

volumes:
  contracts-data:
